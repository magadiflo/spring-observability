# Logs - Segundo pilar de la observabilidad

La observabilidad moderna se apoya en tres pilares fundamentales: `m√©tricas`, `logs` y `traces`.
En esta secci√≥n nos enfocaremos en el segundo: los `logs`.

---

## ¬øQu√© son los Logs en Observabilidad?

- Los `logs` son `registros de eventos` producidos por tu aplicaci√≥n y su infraestructura.
- A diferencia de las m√©tricas (que son valores num√©ricos agregados), los logs son detallados,
  `representan eventos espec√≠ficos`: errores, peticiones, warnings, pasos en un proceso, etc.
- Suelen responder al `qu√© pas√≥` y el `por qu√© pas√≥`, mientras que las `m√©tricas` responden al `cu√°nto pas√≥`.

Ejemplo:

- `M√©trica`: `orders_total = 5`
- `Log`: `"2025-09-09 15:30:45 INFO OrderController - Nueva orden creada con id=123 y producto=Laptop"`

## Niveles de Logs (Log Levels)

Los frameworks de logging usan diferentes niveles de severidad:

````bash
TRACE < DEBUG < INFO < WARN < ERROR 
````

- `TRACE`: Informaci√≥n muy detallada para debugging profundo.
- `DEBUG`: Informaci√≥n √∫til para desarrollo y debugging.
- `INFO`: Eventos importantes del flujo normal de la aplicaci√≥n.
- `WARN`: Situaciones potencialmente problem√°ticas.
- `ERROR`: Errores que no detienen la aplicaci√≥n.

## Caracter√≠sticas de buenos Logs

### Logs no estructurados (texto plano)

````bash
2024-01-15 10:30:15 INFO Order 12345 created for product Laptop with price 999.99
````

### Logs estructurados (JSON)

````json
{
  "timestamp": "2024-01-15T10:30:15Z",
  "level": "INFO",
  "message": "Order created",
  "orderId": "12345",
  "product": "Laptop",
  "price": 999.99,
  "userId": "user123"
}
````

## Opciones de Logs con Spring Boot

Con tu stack `Loki + Grafana`, puedes enfocarte en:

### (A) Logs ‚Äúnormales‚Äù con Logback (por defecto en Spring Boot)

- No necesitas configurar mucho, Loki puede recolectarlos leyendo los stdout de los contenedores Docker.
- Tambi√©n puedes usar `Promtail` para recolectar logs desde archivos si prefieres no depender del logging driver de
  Docker.
- Menos flexibles para an√°lisis avanzado, pero f√°cil de empezar.

### (B) Logs estructurados (JSON)

- Configurar `logback-spring.xml` para producir logs en `JSON`.
- Loki puede parsearlos mejor ‚Üí permite b√∫squedas por campos (orderId, level, etc.).
- Muy recomendado en entornos productivos.

## Frameworks de Logging en Spring Boot

`Spring Boot` viene con `Logback` `por defecto`, pero puedes usar otros frameworks:

### Logback (Default)

Framework de logging sucesor de Log4j, desarrollado por el mismo equipo. Es la `opci√≥n por defecto` en Spring Boot
debido a su estabilidad, performance y facilidad de configuraci√≥n.

### Log4j2

Framework de `logging m√°s reciente` de Apache, dise√±ado desde cero para alta performance y funcionalidades avanzadas.
Requiere configuraci√≥n adicional para usarlo en Spring Boot.

### Java Util Logging (JUL)

Framework de logging nativo de Java, incluido en el JDK. Raramente usado en aplicaciones Spring Boot debido a sus
limitaciones comparado con `Logback` y `Log4j2`.

## üîç Comparativa: `Logback` vs `Log4j2` en Spring Boot

| **Aspecto**                  | **Logback**                              | **Log4j2**                                               |
|------------------------------|------------------------------------------|----------------------------------------------------------|
| **Estado en Spring Boot**    | ‚úÖ **Default** - Incluido autom√°ticamente | ‚ö†Ô∏è Requiere exclusi√≥n de Logback + dependencia adicional |
| **Configuraci√≥n**            | `logback-spring.xml` o `logback.xml`     | `log4j2-spring.xml` o `log4j2.xml`                       |
| **Performance**              | Muy buena                                | ‚úÖ **Mejor** - Especialmente en alta concurrencia         |
| **Asynchronous Logging**     | ‚úÖ Soporte con `AsyncAppender`            | ‚úÖ **Superior** - Async por defecto, menos overhead       |
| **Garbage Collection**       | Genera algo de GC pressure               | ‚úÖ **Mejor** - Garbage-free logging                       |
| **Configuraci√≥n Hot Reload** | ‚úÖ Autom√°tica cuando cambia el archivo    | ‚úÖ Autom√°tica cuando cambia el archivo                    |
| **Filtros**                  | Soporte b√°sico                           | ‚úÖ **M√°s avanzado** - Filtros m√°s flexibles               |
| **Plugins/Extensibilidad**   | Limitada                                 | ‚úÖ **Superior** - Arquitectura de plugins                 |
| **Configuraci√≥n JSON**       | ‚úÖ Via program√°tica o XML                 | ‚úÖ **Nativo** - Soporte JSON/YAML directo                 |
| **Structured Logging**       | ‚úÖ Con configuraci√≥n adicional            | ‚úÖ **Mejor soporte** nativo                               |
| **Lookup Variables**         | Variables b√°sicas                        | ‚úÖ **M√°s opciones** - Sistema avanzado de lookups         |
| **Compatibility**            | ‚úÖ **Excelente** con Spring Boot          | ‚úÖ Buena - Requiere configuraci√≥n adicional               |
| **Curva de Aprendizaje**     | ‚úÖ **M√°s simple** - Menos opciones        | ‚ö†Ô∏è M√°s compleja - M√°s opciones y features                |
| **Documentaci√≥n**            | ‚úÖ Muy buena                              | ‚úÖ Muy buena                                              |
| **Ecosistema Spring**        | ‚úÖ **Integraci√≥n perfecta**               | ‚ö†Ô∏è Buena pero requiere setup manual                      |
| **Tama√±o de Dependencias**   | ‚úÖ **M√°s liviano**                        | ‚ö†Ô∏è M√°s pesado                                            |
| **Configuraci√≥n para Loki**  | ‚úÖ Simple con JSON encoder                | ‚úÖ Simple con JSON layout                                 |
| **Community Support**        | ‚úÖ Muy amplia                             | ‚úÖ Muy amplia                                             |

### üìä Recomendaciones seg√∫n caso de uso

**Usa `Logback` cuando:**

- ‚úÖ Est√°s empezando con observabilidad.
- ‚úÖ Quieres la configuraci√≥n m√°s simple posible.
- ‚úÖ Tu aplicaci√≥n no tiene extrema alta concurrencia.
- ‚úÖ Prefieres el path de menor resistencia en Spring Boot.

**Usa `Log4j2` cuando:**

- ‚úÖ Necesitas m√°xima performance en alta concurrencia.
- ‚úÖ Requieres logging as√≠ncrono intensivo.
- ‚úÖ Necesitas filtros avanzados o configuraci√≥n compleja.
- ‚úÖ Garbage collection es cr√≠tico en tu aplicaci√≥n.
- ‚úÖ Ya tienes experiencia con logging frameworks.

## Definiendo Secuencia de Pasos - Implementaci√≥n de Logs

### FASE 1A: Logback - Logs No Estructurados

1. **Paso 1 ‚Äì Configuraci√≥n del framework de logging:**
    - Configurar `logback-spring.xml` para logs de texto plano
    - No necesitas dependencias adicionales (ya incluido en Spring Boot)
    - Agregar logs variados en OrderController (INFO, WARN, ERROR, DEBUG)

2. **Paso 2 ‚Äì Generar logs en la aplicaci√≥n:**
    - Usar `@Slf4j` (Lombok) para emitir logs en distintos niveles
    - Expandir los logs existentes en OrderController
    - Agregar logs de debug, errores simulados, etc.

3. **Paso 3 ‚Äì Configurar la infraestructura:**
    - Agregar Loki al `docker-compose.yml`
    - Agregar Promtail (para recolectar logs)
    - Configurar Promtail para enviar logs a Loki

4. **Paso 4 ‚Äì Flujo de logs:**
    - App escribe logs a stdout/console
    - Promtail recoge logs del contenedor Docker
    - Promtail env√≠a a Loki con labels autom√°ticos

5. **Paso 5 ‚Äì Visualizaci√≥n en Grafana:**
    - Configurar Loki como datasource
    - Crear queries por level (INFO, WARN, ERROR)
    - Crear dashboards b√°sicos con LogQL
    - Ejemplos de filtros:
        - Por nivel: `{level="INFO"}`
        - Por servicio: `{app="spring-observability"}`
        - B√∫squeda de texto: `{app="spring-observability"} |= "orderId"`

### FASE 1B: Logback - Logs Estructurados (JSON)

1. **Paso 1 ‚Äì Modificar configuraci√≥n:**
    - Actualizar `logback-spring.xml` para formato JSON
    - Mantener el mismo c√≥digo Java (sin cambios)

2-5. **Pasos 2-5:** Repetir flujo anterior, observando diferencias en Grafana

### FASE 2A: Log4j2 - Logs No Estructurados

1. **Paso 1 ‚Äì Migrar framework:**
    - Excluir Logback de dependencias Spring Boot
    - Agregar dependencia Log4j2
    - Configurar `log4j2-spring.xml` para texto plano
    - Mismo c√≥digo Java (sin cambios)

2-5. **Pasos 2-5:** Repetir flujo, comparando con Logback

### FASE 2B: Log4j2 - Logs Estructurados (JSON)

1. **Paso 1 ‚Äì Modificar configuraci√≥n:**
    - Actualizar `log4j2-spring.xml` para formato JSON

2-5. **Pasos 2-5:** Repetir flujo final
