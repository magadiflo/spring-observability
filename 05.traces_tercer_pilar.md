# Traces - Tercer pilar de la observabilidad

La observabilidad moderna se apoya en `tres pilares` fundamentales: `mÃ©tricas`, `logs` y `traces`.
En esta secciÃ³n nos enfocaremos en el tercero: los `traces`, tambiÃ©n llamados `distributed tracing`.

### ğŸ“Š Repaso rÃ¡pido: mÃ©tricas, logs y traces

| Pilar    | Â¿QuÃ© mide?                        | Â¿CuÃ¡ndo usar?                            | Ejemplo                                                  |
|----------|-----------------------------------|------------------------------------------|----------------------------------------------------------|
| MÃ©tricas | Valores numÃ©ricos agregados       | Monitoreo continuo, alertas              | `orders_total = 150`                                     |
| Logs     | Eventos especÃ­ficos en texto      | Debugging, auditorÃ­a                     | `Orden 123 creada exitosamente`                          |
| Traces   | Flujo de requests entre servicios | AnÃ¡lisis de latencia, cuellos de botella | `POST /orders: 290ms` `(APIâ†’Orderâ†’Paymentâ†’Notification)` |

- `MÃ©tricas` â†’ datos numÃ©ricos agregados que muestran el estado del sistema en el tiempo (ej. latencia promedio de
  requests, uso de CPU, throughput).
- `Logs` â†’ registros detallados y estructurados de eventos individuales, Ãºtiles para depuraciÃ³n y auditorÃ­a
  (ej. `Order 123 created successfully`).
- `Traces` â†’ narran el recorrido de una peticiÃ³n a travÃ©s del sistema, mostrando cÃ³mo se propaga entre servicios o
  componentes y cuÃ¡nto tarda cada parte.

> ğŸ‘‰ Mientras que `mÃ©tricas` responden al `quÃ© estÃ¡ pasando` y `logs` al `quÃ© ocurriÃ³` exactamente, los `traces`
> responden al `cÃ³mo fluye una peticiÃ³n`.

### ğŸ”‘ Conceptos clave en tracing

- `Trace` â†’ Representa el flujo completo de una peticiÃ³n de inicio a fin (por ejemplo: crear un pedido).
- `Span` â†’ Unidad de trabajo dentro de un trace (ej. validar datos, persistir pedido, llamar a servicio de pago).
  Cada span tiene inicio, fin y duraciÃ³n.
- `traceId` â†’ Identificador Ãºnico compartido por todos los spans de un mismo trace.
- `spanId` â†’ Identificador Ãºnico de cada span.
- `parentId` â†’ RelaciÃ³n jerÃ¡rquica: indica quÃ© span originÃ³ al actual.

### ğŸ”— RelaciÃ³n con un request real

Cuando un request entra al sistema (por ejemplo, `POST /orders`):

1. Se crea un `traceId` que identifica toda la operaciÃ³n.
2. El request inicial genera un `root span`.
3. Cada operaciÃ³n interna (validaciÃ³n, persistencia, llamadas externas) se representa como child spans.
4. Todos los `spans` se encadenan gracias al campo `parentId`, que apunta al `spanId` de su padre. Con esta relaciÃ³n se
   puede reconstruir el flujo completo de la peticiÃ³n.

Un trace tÃ­pico podrÃ­a representarse asÃ­:

````
traceId: abc123def456    # Ãšnico para todo el request
â”œâ”€â”€ spanId: span-001     # Root span (API Gateway)
â”‚   â””â”€â”€ parentId: null
â”œâ”€â”€ spanId: span-002     # Child span (Order Service)
â”‚   â””â”€â”€ parentId: span-001
â””â”€â”€ spanId: span-003     # Child span (Payment Service)
    â””â”€â”€ parentId: span-001 
````

En este ejemplo:

- Todos los `spans` comparten el mismo `traceId`.
- El `span-001` es el `root span` que inicia la peticiÃ³n.
- Los spans `002` y `003` son hijos que representan operaciones internas, pero mantienen la relaciÃ³n jerÃ¡rquica gracias
  al `parentId`.

AsÃ­, un trace actÃºa como un Ã¡rbol de ejecuciÃ³n que permite entender el recorrido completo de la peticiÃ³n y detectar
cuellos de botella.
